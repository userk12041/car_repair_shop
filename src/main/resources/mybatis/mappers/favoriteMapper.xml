<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.CarRepairDAO">
  <select id="getSortedRepairShops" resultType="com.boot.dto.CarRepairDTO">
    SELECT 
      rs.*, 
      IFNULL(AVG(rv.rating), 0) AS avg_rating,
      COUNT(DISTINCT rv.id) AS review_count,
      COUNT(DISTINCT f.id) AS favorite_count
    FROM repair_shop rs
    LEFT JOIN review rv ON rs.id = rv.repairShopId
    LEFT JOIN favorite f ON rs.id = f.repair_shop_id
    GROUP BY rs.id
    <choose>
      <when test="sort == 'name_asc'">ORDER BY rs.name ASC</when>
	<when test="sort == 'view_desc'">ORDER BY rs.view_count DESC</when>
	<when test="sort == 'date_desc'">ORDER BY rs.registration_date DESC</when>
	<when test="sort == 'favorite_desc'">ORDER BY favorite_count DESC</when>
	<when test="sort == 'review_desc'">ORDER BY avg_rating DESC</when>

      <otherwise>
        ORDER BY rs.id ASC
      </otherwise>
    </choose>
  </select>
</mapper>
